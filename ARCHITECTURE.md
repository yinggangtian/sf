# é¡¹ç›®æ¶æ„ï¼šåˆ†å±‚ + åŒæ¨¡å—è®¾è®¡

**æ ¸å¿ƒç†å¿µï¼šæ•°æ®å±‚ â†’ ä¸šåŠ¡å±‚(AI + Normal) â†’ API å±‚ â†’ å‰ç«¯**

## æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ (React / Vue / ...)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      app/ (FastAPI å±‚)                        â”‚
â”‚  routes/                                                      â”‚
â”‚    â”œâ”€â”€ health.py         # å¥åº·æ£€æŸ¥                          â”‚
â”‚    â”œâ”€â”€ ai.py             # AI å åœç›¸å…³è·¯ç”±                   â”‚
â”‚    â”œâ”€â”€ auth.py           # è®¤è¯ç™»å½•è·¯ç”±                      â”‚
â”‚    â”œâ”€â”€ user.py           # ç”¨æˆ·ç®¡ç†è·¯ç”±                      â”‚
â”‚    â””â”€â”€ admin.py          # ç®¡ç†ç«¯è·¯ç”±                        â”‚
â”‚  main.py                 # FastAPI åº”ç”¨å…¥å£                  â”‚
â”‚  config.py               # å…¨å±€é…ç½®åŠ è½½                      â”‚
â”‚  dependencies.py         # ä¾èµ–æ³¨å…¥ï¼ˆDB/Agent å®ä¾‹ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  backend/         â”‚              â”‚  backend/         â”‚
â”‚  ai_agents/       â”‚              â”‚  normal_backend/  â”‚
â”‚ (AI æ™ºèƒ½æ¨¡å—)      â”‚              â”‚ (ä¼ ç»Ÿåç«¯æ¨¡å—)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ agents/           â”‚              â”‚ auth/             â”‚
â”‚  â”œâ”€â”€ master.py    â”‚              â”‚  â”œâ”€â”€ service.py   â”‚
â”‚  â”œâ”€â”€ orchestratorâ”‚              â”‚  â”œâ”€â”€ jwt_utils.py â”‚
â”‚  â”œâ”€â”€ explainer    â”‚              â”‚  â””â”€â”€ schemas.py   â”‚
â”‚  â””â”€â”€ registry.py  â”‚              â”‚                   â”‚
â”‚                   â”‚              â”‚ user/             â”‚
â”‚ tools/            â”‚              â”‚  â”œâ”€â”€ service.py   â”‚
â”‚  â”œâ”€â”€ liuren.py    â”‚              â”‚  â”œâ”€â”€ crud.py      â”‚
â”‚  â”œâ”€â”€ rag.py       â”‚              â”‚  â””â”€â”€ schemas.py   â”‚
â”‚  â”œâ”€â”€ profile.py   â”‚              â”‚                   â”‚
â”‚  â”œâ”€â”€ history.py   â”‚              â”‚ payment/          â”‚
â”‚  â””â”€â”€ save.py      â”‚              â”‚  â””â”€â”€ service.py   â”‚
â”‚                   â”‚              â”‚                   â”‚
â”‚ xlr/ (æ ¸å¿ƒç®—æ³•)   â”‚              â”‚ notification/     â”‚
â”‚  â”œâ”€â”€ liuren/      â”‚              â”‚  â””â”€â”€ service.py   â”‚
â”‚  â”œâ”€â”€ bazhi/       â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”œâ”€â”€ liuyao/      â”‚
â”‚  â””â”€â”€ adapters/    â”‚
â”‚                   â”‚
â”‚ rag/              â”‚
â”‚  â”œâ”€â”€ build_index  â”‚
â”‚  â”œâ”€â”€ retriever.py â”‚
â”‚  â””â”€â”€ embedder.py  â”‚
â”‚                   â”‚
â”‚ prompts/          â”‚
â”‚  â”œâ”€â”€ system/      â”‚
â”‚  â”œâ”€â”€ tools/       â”‚
â”‚  â””â”€â”€ templates/   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ å…±äº«æ•°æ®è®¿é—®
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              backend/shared/ (å…±äº«å±‚)                       â”‚
â”‚  db/                                                        â”‚
â”‚    â”œâ”€â”€ base.py          # SQLAlchemy Base                  â”‚
â”‚    â”œâ”€â”€ session.py       # DB Session å·¥å‚                  â”‚
â”‚    â”œâ”€â”€ models.py        # ç»Ÿä¸€ ORM æ¨¡å‹                     â”‚
â”‚    â”‚   â”œâ”€â”€ User                                             â”‚
â”‚    â”‚   â”œâ”€â”€ UserProfile                                      â”‚
â”‚    â”‚   â”œâ”€â”€ ConversationSummary                              â”‚
â”‚    â”‚   â”œâ”€â”€ DivinationHistory                                â”‚
â”‚    â”‚   â”œâ”€â”€ KBDocument / KBChunk / KBEmbedding               â”‚
â”‚    â”‚   â””â”€â”€ Payment / Notification ...                       â”‚
â”‚    â””â”€â”€ migrations/      # Alembic è¿ç§»è„šæœ¬                  â”‚
â”‚  exceptions.py          # å…¨å±€å¼‚å¸¸å®šä¹‰                       â”‚
â”‚  utils.py               # é€šç”¨å·¥å…·å‡½æ•°                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Postgres + pgvector (æ•°æ®å­˜å‚¨å±‚)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®Œæ•´ç›®å½•ç»“æ„

```bash
SF/
â”œâ”€â”€ app/                        # FastAPI åº”ç”¨å±‚
â”‚   â”œâ”€â”€ main.py                 # å…¥å£ï¼šFastAPI app + CORS + ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ config.py               # ç¯å¢ƒå˜é‡ä¸é…ç½®åŠ è½½
â”‚   â”œâ”€â”€ dependencies.py         # ä¾èµ–æ³¨å…¥ï¼šget_db, get_agent, get_current_user
â”‚   â””â”€â”€ routes/                 # API è·¯ç”±æ¨¡å—
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ health.py           # GET /health
â”‚       â”œâ”€â”€ ai.py               # POST /ai/divination, /ai/history ç­‰
â”‚       â”œâ”€â”€ auth.py             # POST /auth/login, /auth/register
â”‚       â”œâ”€â”€ user.py             # GET/PUT /user/profile
â”‚       â””â”€â”€ admin.py            # POST /admin/kb/import (ç®¡ç†ç«¯)
â”‚
â”œâ”€â”€ backend/                    # åç«¯ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ ai_agents/              # AI æ™ºèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ agents/             # Agent å®šä¹‰ä¸ç¼–æ’
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ master_agent.py      # ä¸» Agentï¼ˆOpenAI Agents SDKï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ orchestrator.py      # Orchestratorï¼šæ„å›¾ + æ§½ä½ + è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ explainer.py         # Explainerï¼šè§£é‡Šç”Ÿæˆ + Guardrails
â”‚   â”‚   â”‚   â””â”€â”€ registry.py          # AlgorithmRegistry
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ services/           # ğŸ†• ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚ï¼ˆè§£è€¦å·¥å…·ä¸ç®—æ³•ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ divination_service.py    # å åœä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ rag_service.py           # RAG æŸ¥è¯¢ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ memory_service.py        # Memory è¯»å†™ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â””â”€â”€ history_service.py       # å†å²è®°å½•ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ tools/              # Agent å·¥å…·å°è£…ï¼ˆå‚æ•°è½¬æ¢ï¼Œè°ƒç”¨ servicesï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ liuren_tool.py       # å°å…­å£¬å åœå·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ rag_tool.py          # RAG æ£€ç´¢å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ profile_tool.py      # ç”¨æˆ·ç”»åƒè¯»å†™
â”‚   â”‚   â”‚   â”œâ”€â”€ history_tool.py      # å†å²è®°å½•æŸ¥è¯¢
â”‚   â”‚   â”‚   â”œâ”€â”€ summary_tool.py      # å¯¹è¯æ‘˜è¦æ›´æ–°
â”‚   â”‚   â”‚   â””â”€â”€ save_result_tool.py  # å åœç»“æœä¿å­˜
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ xlr/                # ç„å­¦ç®—æ³•æ ¸å¿ƒå¼•æ“ï¼ˆå¯æ‰©å±•å¤šç§ç®—æ³•ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ adapters/       # ç®—æ³•é€‚é…å™¨æŠ½è±¡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ base.py          # AlgorithmAdapter åŸºç±»
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ liuren_adapter.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ bazhi_adapter.py  # å…«å­—ï¼ˆå¾…å®ç°ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ liuyao_adapter.py # å…­çˆ»ï¼ˆå¾…å®ç°ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ liuren/         # å°å…­å£¬ç®—æ³•å®ç°
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ engine.py        # æ ¸å¿ƒæ’ç›˜é€»è¾‘
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ utils.py
â”‚   â”‚   â”‚   â””â”€â”€ schemas.py      # ç®—æ³•è¾“å…¥è¾“å‡º Schema
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ rag/                # RAG æ£€ç´¢æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ build_index.py       # ç¦»çº¿ç´¢å¼•æ„å»ºè„šæœ¬
â”‚   â”‚   â”‚   â”œâ”€â”€ retriever.py         # åœ¨çº¿æ£€ç´¢å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ embedder.py          # å‘é‡åŒ–å°è£…
â”‚   â”‚   â”‚   â””â”€â”€ schemas.py           # RAG ç›¸å…³ Schema
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ prompts/            # Prompt æ¨¡æ¿ä¸é…ç½®
â”‚   â”‚       â”œâ”€â”€ system/
â”‚   â”‚       â”‚   â”œâ”€â”€ base.yaml                # åŸºç¡€äººæ ¼
â”‚   â”‚       â”‚   â”œâ”€â”€ orchestrator.yaml        # Orchestrator ä¸“ç”¨
â”‚   â”‚       â”‚   â””â”€â”€ explainer.yaml           # Explainer ä¸“ç”¨
â”‚   â”‚       â”œâ”€â”€ scenarios/      # ğŸ†• åœºæ™¯åŒ– Prompt
â”‚   â”‚       â”‚   â”œâ”€â”€ slot_filling.md          # æ§½ä½è¿½é—®è¯æœ¯
â”‚   â”‚       â”‚   â”œâ”€â”€ clarification.md         # æ­§ä¹‰æ¾„æ¸…è¯æœ¯
â”‚   â”‚       â”‚   â””â”€â”€ error_handling.md        # é”™è¯¯æç¤ºè¯æœ¯
â”‚   â”‚       â”œâ”€â”€ tools/
â”‚   â”‚       â”‚   â”œâ”€â”€ liuren_tool.md
â”‚   â”‚       â”‚   â”œâ”€â”€ rag_tool.md
â”‚   â”‚       â”‚   â””â”€â”€ profile_tool.md
â”‚   â”‚       â””â”€â”€ templates/
â”‚   â”‚           â”œâ”€â”€ reply_basic.md           # åŸºç¡€è§£è¯»æ¨¡æ¿
â”‚   â”‚           â”œâ”€â”€ reply_advanced.md        # é«˜çº§è§£è¯»æ¨¡æ¿
â”‚   â”‚           â””â”€â”€ versions/    # ğŸ†• æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†
â”‚   â”‚               â”œâ”€â”€ v1.0/
â”‚   â”‚               â””â”€â”€ v2.0/
â”‚   â”‚
â”‚   â”œâ”€â”€ normal_backend/         # ä¼ ç»Ÿåç«¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth/               # è®¤è¯æˆæƒæ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ service.py           # æ³¨å†Œ/ç™»å½•/Token é€»è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ jwt_utils.py         # JWT ç”Ÿæˆä¸æ ¡éªŒ
â”‚   â”‚   â”‚   â””â”€â”€ schemas.py           # Request/Response Schema
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ user/               # ç”¨æˆ·ç®¡ç†æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ service.py           # ç”¨æˆ· CRUD ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ crud.py              # æ•°æ®åº“æ“ä½œå°è£…
â”‚   â”‚   â”‚   â””â”€â”€ schemas.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ payment/            # æ”¯ä»˜æ¨¡å—ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ service.py
â”‚   â”‚   â”‚   â””â”€â”€ schemas.py
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ notification/       # é€šçŸ¥æ¨¡å—ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ service.py
â”‚   â”‚       â””â”€â”€ schemas.py
â”‚   â”‚
â”‚   â””â”€â”€ shared/                 # å…±äº«å±‚ï¼ˆæ•°æ®åº“ + é€šç”¨å·¥å…·ï¼‰
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ config/             # ğŸ†• ç»Ÿä¸€é…ç½®ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ base.py              # åŸºç¡€é…ç½®ç±»
â”‚       â”‚   â”œâ”€â”€ development.py       # å¼€å‘ç¯å¢ƒé…ç½®
â”‚       â”‚   â”œâ”€â”€ production.py        # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”‚       â”‚   â””â”€â”€ settings.py          # Pydantic é…ç½®æ¨¡å‹
â”‚       â”‚
â”‚       â”œâ”€â”€ db/
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ base.py              # SQLAlchemy Base
â”‚       â”‚   â”œâ”€â”€ session.py           # get_db / SessionLocal
â”‚       â”‚   â”œâ”€â”€ models/          # ğŸ†• æ‹†åˆ†ä¸ºæ¨¡å—ç›®å½•
â”‚       â”‚   â”‚   â”œâ”€â”€ __init__.py      # å¯¼å‡ºæ‰€æœ‰æ¨¡å‹
â”‚       â”‚   â”‚   â”œâ”€â”€ user.py          # User, UserProfile
â”‚       â”‚   â”‚   â”œâ”€â”€ divination.py    # DivinationHistory, ConversationSummary
â”‚       â”‚   â”‚   â”œâ”€â”€ knowledge.py     # KBDocument, KBChunk, KBEmbedding
â”‚       â”‚   â”‚   â””â”€â”€ payment.py       # Payment, Transaction
â”‚       â”‚   â”œâ”€â”€ migrations/          # Alembic è¿ç§»è„šæœ¬
â”‚       â”‚   â””â”€â”€ init_db.py           # åˆå§‹åŒ–è„šæœ¬
â”‚       â”‚
â”‚       â”œâ”€â”€ observability/      # ğŸ†• ç›‘æ§ä¸æ—¥å¿—
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ logger.py            # ç»Ÿä¸€æ—¥å¿—é…ç½®ï¼ˆstructlogï¼‰
â”‚       â”‚   â”œâ”€â”€ metrics.py           # æŒ‡æ ‡é‡‡é›†ï¼ˆPrometheusï¼‰
â”‚       â”‚   â””â”€â”€ tracing.py           # é“¾è·¯è¿½è¸ªï¼ˆOpenTelemetryï¼‰
â”‚       â”‚
â”‚       â”œâ”€â”€ tasks/              # ğŸ†• å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ celery_app.py        # Celery é…ç½®
â”‚       â”‚   â”œâ”€â”€ rag_tasks.py         # RAG ç›¸å…³å¼‚æ­¥ä»»åŠ¡
â”‚       â”‚   â””â”€â”€ summary_tasks.py     # æ‘˜è¦ç”Ÿæˆä»»åŠ¡
â”‚       â”‚
â”‚       â”œâ”€â”€ exceptions.py            # å…¨å±€å¼‚å¸¸ç±»
â”‚       â””â”€â”€ utils.py                 # é€šç”¨å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ scripts/                    # è¿ç»´è„šæœ¬
â”‚   â”œâ”€â”€ load_kb_from_markdown.py     # å¯¼å…¥çŸ¥è¯†åº“
â”‚   â”œâ”€â”€ init_db.sh                   # åˆå§‹åŒ–æ•°æ®åº“
â”‚   â””â”€â”€ demo_cli.py                  # å‘½ä»¤è¡Œæµ‹è¯•
â”‚
â”œâ”€â”€ tests/                      # æµ‹è¯•ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ unit/                   # ğŸ†• å•å…ƒæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_liuren_engine.py
â”‚   â”‚   â”œâ”€â”€ test_auth_service.py
â”‚   â”‚   â”œâ”€â”€ test_rag_retriever.py
â”‚   â”‚   â””â”€â”€ test_config.py
â”‚   â”œâ”€â”€ integration/            # ğŸ†• é›†æˆæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_orchestrator_flow.py
â”‚   â”‚   â”œâ”€â”€ test_user_registration.py
â”‚   â”‚   â””â”€â”€ test_rag_indexing.py
â”‚   â”œâ”€â”€ e2e/                    # ğŸ†• ç«¯åˆ°ç«¯æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_full_divination_flow.py
â”‚   â”‚   â””â”€â”€ test_auth_to_divination.py
â”‚   â”œâ”€â”€ fixtures/               # ğŸ†• æµ‹è¯•æ•°æ®
â”‚   â”‚   â”œâ”€â”€ users.json
â”‚   â”‚   â”œâ”€â”€ kb_samples.md
â”‚   â”‚   â””â”€â”€ mock_responses.json
â”‚   â””â”€â”€ conftest.py             # pytest é…ç½®
â”‚
â”œâ”€â”€ openspec/                   # OpenSpec è§„èŒƒç®¡ç†
â”‚   â”œâ”€â”€ project.md
â”‚   â”œâ”€â”€ checklists.md
â”‚   â”œâ”€â”€ specs/
â”‚   â””â”€â”€ changes/
â”‚
â”œâ”€â”€ .env.example
â”œâ”€â”€ pyproject.toml / requirements.txt
â”œâ”€â”€ alembic.ini
â””â”€â”€ README.md
```

## æ¨¡å—èŒè´£è¯´æ˜

### app/ - API å±‚
- å”¯ä¸€å¯¹å¤–æ¥å£ï¼Œè´Ÿè´£è·¯ç”±ã€è¯·æ±‚æ ¡éªŒã€å“åº”å°è£…
- é€šè¿‡ `dependencies.py` æ³¨å…¥ DB Session å’Œ Agent å®ä¾‹
- ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œä»…è°ƒç”¨ `backend/` ä¸‹çš„æœåŠ¡

### backend/ai_agents/ - AI æ™ºèƒ½æ¨¡å—
- **agents/**: Agent ç¼–æ’é€»è¾‘ï¼ˆOrchestrator + Explainerï¼‰
- **services/**: ğŸ†• ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚ï¼Œè§£è€¦å·¥å…·ä¸ç®—æ³•å®ç°ï¼ˆdivination/rag/memory/historyï¼‰
- **tools/**: Agent å¯è°ƒç”¨çš„å·¥å…·ï¼ˆå‚æ•°è½¬æ¢ï¼Œè°ƒç”¨ services å±‚ï¼‰
- **xlr/**: ç„å­¦ç®—æ³•æ ¸å¿ƒå®ç°ä¸é€‚é…å™¨æŠ½è±¡
- **rag/**: å‘é‡æ£€ç´¢ä¸çŸ¥è¯†åº“ç®¡ç†
- **prompts/**: System Prompt ä¸å›å¤æ¨¡æ¿ï¼ˆå¢å¼ºåœºæ™¯åŒ–ä¸ç‰ˆæœ¬ç®¡ç†ï¼‰

### backend/normal_backend/ - ä¼ ç»Ÿåç«¯æ¨¡å—
- **auth/**: JWT è®¤è¯ã€ç”¨æˆ·æ³¨å†Œç™»å½•
- **user/**: ç”¨æˆ·ä¿¡æ¯ CRUD
- **payment/**: æ”¯ä»˜é›†æˆï¼ˆå¯é€‰ï¼‰
- **notification/**: æ¶ˆæ¯æ¨é€ï¼ˆå¯é€‰ï¼‰

### backend/shared/ - å…±äº«å±‚
- **config/**: ğŸ†• ç»Ÿä¸€é…ç½®ç®¡ç†ï¼ˆPydantic Settingsï¼Œæ”¯æŒå¤šç¯å¢ƒï¼‰
- **db/**: ç»Ÿä¸€æ•°æ®åº“è®¿é—®
  - **models/**: ğŸ†• ORM æ¨¡å‹æŒ‰ä¸šåŠ¡æ‹†åˆ†ï¼ˆuser/divination/knowledge/paymentï¼‰
  - **base.py / session.py**: SQLAlchemy åŸºç¡€é…ç½®
- **observability/**: ğŸ†• ç›‘æ§ä¸æ—¥å¿—ï¼ˆlogger/metrics/tracingï¼‰
- **tasks/**: ğŸ†• å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆCeleryï¼Œæ”¯æŒ RAG ç´¢å¼•/æ‘˜è¦ç”Ÿæˆç­‰é•¿ä»»åŠ¡ï¼‰
- **exceptions.py**: å…¨å±€å¼‚å¸¸ç±»å®šä¹‰
- **utils.py**: è·¨æ¨¡å—é€šç”¨å·¥å…·å‡½æ•°

## æ•°æ®æµå‘

1. **ç”¨æˆ·æ³¨å†Œ/ç™»å½•**: å‰ç«¯ â†’ `app/routes/auth.py` â†’ `backend/normal_backend/auth/service.py` â†’ `backend/shared/db/models/user.py`
2. **AI å åœè¯·æ±‚**: å‰ç«¯ â†’ `app/routes/ai.py` â†’ `backend/ai_agents/agents/orchestrator.py` â†’ `backend/ai_agents/tools/liuren_tool.py` â†’ `backend/ai_agents/services/divination_service.py` â†’ `backend/ai_agents/xlr/liuren/engine.py` â†’ `backend/shared/db/models/divination.py`
3. **ç”¨æˆ·ä¿¡æ¯ç®¡ç†**: å‰ç«¯ â†’ `app/routes/user.py` â†’ `backend/normal_backend/user/service.py` â†’ `backend/shared/db/models/user.py`
4. **RAG ç´¢å¼•æ„å»º**: `scripts/load_kb.py` â†’ `backend/shared/tasks/rag_tasks.py` (Celery) â†’ `backend/ai_agents/rag/build_index.py` â†’ `backend/shared/db/models/knowledge.py`

## å…³é”®æ”¹è¿›ç‚¹ï¼ˆç›¸æ¯”åˆç‰ˆï¼‰

### ğŸ”´ P0 æ”¹è¿›
1. **æ‹†åˆ† models.py**ï¼šæŒ‰ä¸šåŠ¡åŸŸæ‹†åˆ†ä¸º user/divination/knowledge/paymentï¼Œé¿å…å•æ–‡ä»¶è¿‡å¤§
2. **å¼•å…¥ services å±‚**ï¼šå·¥å…·å±‚é€šè¿‡ services è°ƒç”¨ç®—æ³•ï¼Œé™ä½è€¦åˆ

### ğŸŸ¡ P1 æ”¹è¿›
3. **å®Œå–„ Prompts ç»“æ„**ï¼šå¢åŠ åœºæ™¯åŒ– Promptï¼ˆslot_filling/clarification/error_handlingï¼‰å’Œç‰ˆæœ¬ç®¡ç†
4. **ç»Ÿä¸€é…ç½®ç®¡ç†**ï¼šPydantic Settings æ”¯æŒå¤šç¯å¢ƒï¼Œé›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®å‚æ•°

### ğŸŸ¢ P2 æ”¹è¿›
5. **æµ‹è¯•åˆ†å±‚**ï¼šunit/integration/e2e + fixtures ç›®å½•ï¼Œæå‡æµ‹è¯•è´¨é‡
6. **ç›‘æ§æ—¥å¿—**ï¼šobservability æ¨¡å—ç»Ÿä¸€æ—¥å¿—æ ¼å¼ä¸æŒ‡æ ‡é‡‡é›†

### ğŸŸ¢ P3 æ”¹è¿›
7. **å¼‚æ­¥ä»»åŠ¡**ï¼šCelery æ”¯æŒ RAG ç´¢å¼•ã€æ‰¹é‡å¯¼å‡ºã€å®šæ—¶æ‘˜è¦ç­‰é•¿è€—æ—¶ä»»åŠ¡

## å…³é”®çº¦å®š

- æ‰€æœ‰æ•°æ®åº“æ“ä½œç»Ÿä¸€é€šè¿‡ `backend/shared/db/` è¿›è¡Œ
- AI æ¨¡å—ä¸ Normal æ¨¡å—äº’ä¸ä¾èµ–ï¼Œä»…å…±äº«æ•°æ®å±‚
- FastAPI è·¯ç”±ä»…åšå‚æ•°æ ¡éªŒä¸å“åº”å°è£…ï¼Œä¸šåŠ¡é€»è¾‘ä¸‹æ²‰åˆ° `backend/`
- **å·¥å…·å±‚è°ƒç”¨æœåŠ¡å±‚**ï¼š`tools/` ä¸ç›´æ¥è®¿é—®ç®—æ³•å®ç°ï¼Œé€šè¿‡ `services/` è§£è€¦
- **ORM æ¨¡å‹æŒ‰ä¸šåŠ¡æ‹†åˆ†**ï¼šé¿å…å•æ–‡ä»¶è¿‡å¤§ï¼Œå‡å°‘åˆå¹¶å†²çª
- **é…ç½®åˆ†ç¯å¢ƒç®¡ç†**ï¼šä½¿ç”¨ Pydantic Settingsï¼Œæ”¯æŒ .env ä¸ç¯å¢ƒå˜é‡
- **æµ‹è¯•åˆ†å±‚æ¸…æ™°**ï¼šunitï¼ˆå•å…ƒï¼‰/ integrationï¼ˆé›†æˆï¼‰/ e2eï¼ˆç«¯åˆ°ç«¯ï¼‰
- **ç›‘æ§ä¸æ—¥å¿—æ ‡å‡†åŒ–**ï¼šä½¿ç”¨ structlog + Prometheus + OpenTelemetry
- **é•¿ä»»åŠ¡å¼‚æ­¥åŒ–**ï¼šRAG ç´¢å¼•æ„å»ºã€æ‰¹é‡å¯¼å‡ºç­‰ä½¿ç”¨ Celery
